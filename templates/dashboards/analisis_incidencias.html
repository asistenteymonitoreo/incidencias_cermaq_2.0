{% extends 'dashboards/base_dashboard.html' %}

{% block title %}An谩lisis de Incidencias{% endblock %}

{% block content %}
<h1> An谩lisis de Incidencias</h1>
<p class="dashboard-subtitle">Profundizaci贸n en problemas operacionales</p>

<section class="metrics-grid">
    <div class="metric-card">
        <div class="metric-icon"></div>
        <div class="metric-content">
            <h3>{{ top_incidencias|length }}</h3>
            <p>Tipos de Incidencias</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon">锔</div>
        <div class="metric-content">
            <h3>{{ criticas|length }}</h3>
            <p>Cr铆ticas Activas</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"></div>
        <div class="metric-content">
            <h3>{{ recurrentes|length }}</h3>
            <p>Recurrentes</p>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-icon"></div>
        <div class="metric-content">
            <h3>{{ por_modulo|length }}</h3>
            <p>M贸dulos Afectados</p>
        </div>
    </div>
</section>

<section class="dashboard-charts-grid">
    <div class="chart-card">
        <h3> Top 10 Incidencias M谩s Frecuentes</h3>
        <canvas id="chartTopIncidencias"></canvas>
    </div>
    
    <div class="chart-card">
        <h3> Evoluci贸n Temporal</h3>
        <canvas id="chartEvolucion"></canvas>
    </div>
    
    <div class="chart-card">
        <h3> Incidencias por M贸dulo</h3>
        <canvas id="chartPorModulo"></canvas>
    </div>
    
    <div class="chart-card">
        <h3>锔 Incidencias Cr铆ticas Sin Resolver</h3>
        <div style="overflow-y: auto; max-height: 400px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8f9fa; position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 12px; text-align: left;">Fecha</th>
                        <th style="padding: 12px; text-align: left;">Tipo</th>
                        <th style="padding: 12px; text-align: left;">M贸dulo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inc in criticas %}
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px;">{{ inc.fecha_hora|date:"d/m H:i" }}</td>
                        <td style="padding: 12px;">{{ inc.tipo_incidencia }}</td>
                        <td style="padding: 12px;">{{ inc.modulo }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    new Chart(document.getElementById('chartTopIncidencias'), {
        type: 'bar',
        data: {
            labels: [{% for item in top_incidencias %}'{{ item.tipo_incidencia }}',{% endfor %}],
            datasets: [{
                label: 'Cantidad',
                data: [{% for item in top_incidencias %}{{ item.total }},{% endfor %}],
                backgroundColor: '#17a2b8'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
    });
    
    new Chart(document.getElementById('chartEvolucion'), {
        type: 'line',
        data: {
            labels: {{ evolucion_labels|safe }},
            datasets: [{
                label: 'Incidencias',
                data: {{ evolucion_data|safe }},
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    new Chart(document.getElementById('chartPorModulo'), {
        type: 'bar',
        data: {
            labels: [{% for item in por_modulo %}'{{ item.modulo }}',{% endfor %}],
            datasets: [{
                label: 'Incidencias',
                data: [{% for item in por_modulo %}{{ item.total }},{% endfor %}],
                backgroundColor: '#ffc107'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
</script>
{% endblock %}
