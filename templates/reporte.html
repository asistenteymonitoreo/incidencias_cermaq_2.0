{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Diario de Incidencias - Cermaq Chile</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
    <link rel="icon" type="image/png" href="{% static 'imagenes/logo-pesta√±a.png' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <div class="page-layout">

        <div class="form-container" id="reporte-container"> 
            
            <header class="reporte-header-premium">
                {% csrf_token %}
                <div class="header-top-bar">
                    <div class="logo-section">
                        <img src="{% static 'imagenes/logo-pesta√±a.png' %}" alt="Logo Cermaq Chile" class="header-logo">
                        <div class="header-title-group">
                            <h1 id="reporteTitulo">üìã Reporte de Incidencias</h1>
                            <p class="header-subtitle">Sistema de Gesti√≥n y Monitoreo</p>
                        </div>
                    </div>
                    <div class="header-stats-premium">
                        <div class="stat-card stat-total">
                            <div class="stat-icon">üìä</div>
                            <div class="stat-content">
                                <div class="stat-number" id="totalIncidenciasHeader">{{ total_incidencias }}</div>
                                <div class="stat-label">Total Registradas</div>
                            </div>
                        </div>
                        <div class="stat-card stat-page">
                            <div class="stat-icon">üìÑ</div>
                            <div class="stat-content">
                                <div class="stat-number" id="incidenciasFiltradasHeader">{{ incidencias|length }}</div>
                                <div class="stat-label">En esta P√°gina</div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <section class="filtros-panel-profesional" id="filtrosReporteSection">
                <div class="filtros-header">
                    <h2>üîç Panel de Filtros Avanzados</h2>
                </div>
                
                <div class="filtros-grid">
                    <div class="filtro-card">
                        <div class="filtro-icon">üìÖ</div>
                        <div class="filtro-content">
                            <label for="filtroFecha">Fecha Espec√≠fica</label>
                            <input type="date" id="filtroFecha" name="filtroFecha" class="filtro-input">
                        </div>
                    </div>

                    <div class="filtro-card">
                        <div class="filtro-icon">‚öôÔ∏è</div>
                        <div class="filtro-content">
                            <label for="filtroTipoIncidencia">Tipo de Incidencia</label>
                            <select id="filtroTipoIncidencia" name="filtroTipoIncidencia" class="filtro-select">
                                <option value="">Todos los Tipos</option>
                                <option value="modulos">Par√°metros de M√≥dulos y Estanques</option>
                                <option value="sensores">Sistemas de Sensores</option>
                            </select>
                        </div>
                    </div>

                    <div class="filtro-card">
                        <div class="filtro-icon">üïê</div>
                        <div class="filtro-content">
                            <label for="filtroTurno">Turno de Trabajo</label>
                            <select id="filtroTurno" name="filtroTurno" class="filtro-select">
                                <option value="">Todos los Turnos</option>
                                <option value="Ma√±ana">Ma√±ana</option>
                                <option value="Tarde">Tarde</option>
                                <option value="Noche">Noche</option>
                            </select>
                        </div>
                    </div>

                    <div class="filtro-card">
                        <div class="filtro-icon">üè¢</div>
                        <div class="filtro-content">
                            <label for="filtroCentro">Centro de Operaciones</label>
                            <select id="filtroCentro" name="filtroCentro" class="filtro-select">
                                <option value="">Todos los Centros</option>
                                {% for c in centros %}
                                    <option value="{{ c.id }}">{{ c.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="filtros-actions">
                    <button id="aplicarFiltrosBtn" class="btn-filtro-aplicar">
                        <i class="fas fa-filter"></i>
                        Aplicar Filtros
                    </button>
                    <button id="resetFiltrosBtn" class="btn-filtro-reset">
                        <i class="fas fa-undo"></i>
                        Restablecer
                    </button>
                </div>
            </section>

            <section id="reporteIncidenciasSection">
                <div id="incidenciasReporteContainer" class="incidencias-grid">
                    
                    {% for inc in incidencias %}
                    <div class="incidencia-card-premium {% if inc.tiempo_resolucion %}{% if inc.tiempo_resolucion <= 20 %}kpi-excelente{% elif inc.tiempo_resolucion <= 30 %}kpi-aceptable{% else %}kpi-critico{% endif %}{% endif %}" 
                         data-centro="{{ inc.centro.id }}" 
                         data-turno="{{ inc.turno }}" 
                         data-tipo="{{ inc.tipo_incidencia }}" 
                         data-fecha="{{ inc.fecha_hora|date:"Y-m-d" }}">
                        
                        <!-- Barra Superior con KPI -->
                        <div class="card-kpi-bar {% if inc.tiempo_resolucion %}{% if inc.tiempo_resolucion <= 20 %}bar-excelente{% elif inc.tiempo_resolucion <= 30 %}bar-aceptable{% else %}bar-critico{% endif %}{% else %}bar-sin-dato{% endif %}">
                            <div class="kpi-info">
                                <span class="kpi-label">TIEMPO DE RESPUESTA</span>
                                <span class="kpi-value">
                                    {% if inc.tiempo_resolucion %}
                                        {{ inc.tiempo_resolucion }} min
                                        {% if inc.tiempo_resolucion <= 20 %}
                                            <span class="kpi-status">‚úì Cumple KPI</span>
                                        {% elif inc.tiempo_resolucion <= 30 %}
                                            <span class="kpi-status">‚ö† Fuera de KPI</span>
                                        {% else %}
                                            <span class="kpi-status">‚úó Cr√≠tico</span>
                                        {% endif %}
                                    {% else %}
                                        Sin registro
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Header Principal -->
                        <div class="card-header-premium">
                            <div class="centro-badge">
                                <span class="centro-icon">üè¢</span>
                                <span class="centro-nombre">{% if inc.centro %}{{ inc.centro.nombre }}{% else %}Centro no especificado{% endif %}</span>
                            </div>
                            <div class="fecha-badge">
                                <span class="fecha-icon">üìÖ</span>
                                <span class="fecha-valor">{{ inc.fecha_hora|date:"d/m/Y" }}</span>
                                <span class="hora-valor">{{ inc.fecha_hora|date:"H:i" }}</span>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n de Ubicaci√≥n y Turno -->
                        <div class="card-ubicacion-section">
                            <div class="ubicacion-item">
                                <span class="ubi-icon">üìç</span>
                                <div class="ubi-content">
                                    <span class="ubi-label">M√≥dulo</span>
                                    <span class="ubi-value">{{ inc.modulo|default:"N/A" }}</span>
                                </div>
                            </div>
                            <div class="ubicacion-item">
                                <span class="ubi-icon">üéØ</span>
                                <div class="ubi-content">
                                    <span class="ubi-label">Estanque</span>
                                    <span class="ubi-value">{{ inc.estanque|default:"N/A" }}</span>
                                </div>
                            </div>
                            <div class="ubicacion-item">
                                <span class="ubi-icon">üïê</span>
                                <div class="ubi-content">
                                    <span class="ubi-label">Turno</span>
                                    <span class="ubi-value">{{ inc.turno }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tipo de Incidencia y Sistema -->
                        <div class="card-sistema-section">
                            <div class="sistema-badge tipo-{{ inc.tipo_incidencia }}">
                                <span class="sistema-icon">‚öôÔ∏è</span>
                                <span class="sistema-text">{{ inc.tipo_incidencia|upper|default:"SISTEMA" }}</span>
                            </div>
                        </div>
                        
                        <!-- Clasificaci√≥n de Falla (Destacada) -->
                        <div class="card-falla-principal">
                            <div class="falla-icon">‚ö†Ô∏è</div>
                            <div class="falla-content">
                                <span class="falla-label">TIPO DE FALLA</span>
                                <span class="falla-descripcion">{{ inc.tipo_incidencia_normalizada|default:"Sin clasificaci√≥n espec√≠fica" }}</span>
                            </div>
                        </div>
                        
                        <!-- Par√°metros T√©cnicos Mejorados -->
                        {% if inc.oxigeno_valor or inc.temperatura_valor or inc.conductividad_nivel or inc.turbidez_valor or inc.sensor_valor %}
                        <div class="card-parametros-premium">
                            <div class="parametros-header">
                                <span class="param-icon">üìä</span>
                                <span class="param-title">PAR√ÅMETROS MEDIDOS</span>
                            </div>
                            <div class="parametros-list">
                                {% if inc.oxigeno_valor %}
                                    <div class="param-item param-oxigeno">
                                        <span class="param-name">üíß Ox√≠geno</span>
                                        <span class="param-val">{{ inc.oxigeno_valor }} mg/L</span>
                                        {% if inc.oxigeno_nivel %}<span class="param-nivel nivel-{{ inc.oxigeno_nivel|lower }}">{{ inc.oxigeno_nivel }}</span>{% endif %}
                                    </div>
                                {% endif %}
                                {% if inc.temperatura_valor %}
                                    <div class="param-item param-temperatura">
                                        <span class="param-name">üå°Ô∏è Temperatura</span>
                                        <span class="param-val">{{ inc.temperatura_valor }}¬∞C</span>
                                        {% if inc.temperatura_nivel %}<span class="param-nivel nivel-{{ inc.temperatura_nivel|lower }}">{{ inc.temperatura_nivel }}</span>{% endif %}
                                    </div>
                                {% endif %}
                                {% if inc.conductividad_nivel %}
                                    <div class="param-item param-conductividad">
                                        <span class="param-name">‚ö° Conductividad</span>
                                        <span class="param-val">{{ inc.conductividad_nivel }}</span>
                                    </div>
                                {% endif %}
                                {% if inc.turbidez_valor %}
                                    <div class="param-item param-turbidez">
                                        <span class="param-name">üå´Ô∏è Turbidez</span>
                                        <span class="param-val">{{ inc.turbidez_valor }}</span>
                                        {% if inc.turbidez_nivel %}<span class="param-nivel">{{ inc.turbidez_nivel }}</span>{% endif %}
                                    </div>
                                {% endif %}
                                {% if inc.sensor_valor and inc.tipo_incidencia == "sensores" %}
                                    <div class="param-item param-sensor">
                                        <span class="param-name">üì° {{ inc.sensor_detectado }}</span>
                                        <span class="param-val">{{ inc.sensor_valor }}</span>
                                        {% if inc.sensor_nivel %}<span class="param-nivel">{{ inc.sensor_nivel }}</span>{% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Riesgos Identificados -->
                        <div class="card-riesgos-section">
                            <div class="riesgo-item {% if inc.riesgo_peces %}riesgo-activo{% endif %}">
                                <span class="riesgo-icon">üêü</span>
                                <span class="riesgo-text">Riesgo Peces</span>
                                <span class="riesgo-estado">{% if inc.riesgo_peces %}S√ç{% else %}NO{% endif %}</span>
                            </div>
                            <div class="riesgo-item {% if inc.perdida_economica %}riesgo-activo{% endif %}">
                                <span class="riesgo-icon">üí∞</span>
                                <span class="riesgo-text">P√©rdida Econ√≥mica</span>
                                <span class="riesgo-estado">{% if inc.perdida_economica %}S√ç{% else %}NO{% endif %}</span>
                            </div>
                            <div class="riesgo-item {% if inc.riesgo_personas %}riesgo-activo{% endif %}">
                                <span class="riesgo-icon">üë∑</span>
                                <span class="riesgo-text">Riesgo Personas</span>
                                <span class="riesgo-estado">{% if inc.riesgo_personas %}S√ç{% else %}NO{% endif %}</span>
                            </div>
                        </div>
                        
                        <!-- Operario Responsable -->
                        {% if inc.operario_contacto %}
                        <div class="card-operario-section">
                            <div class="operario-avatar">üë§</div>
                            <div class="operario-datos">
                                <span class="operario-label">Operario de Contacto</span>
                                <span class="operario-nombre">{{ inc.operario_contacto.nombre }}</span>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Observaciones -->
                        {% if inc.observacion %}
                        <div class="card-observacion-section">
                            <div class="obs-header">
                                <span class="obs-icon">üí¨</span>
                                <span class="obs-title">Observaciones</span>
                            </div>
                            <p class="obs-text">{{ inc.observacion }}</p>
                        </div>
                        {% endif %}

                        {% if es_admin %}
                        <div class="card-actions-premium">
                            <a href="{% url 'editar_incidencia' inc.pk %}" class="btn-action btn-edit">
                                <span class="btn-icon">‚úèÔ∏è</span>
                                <span class="btn-text">Editar</span>
                            </a>
                            <button type="button" class="btn-action btn-delete" data-id="{{ inc.id }}">
                                <span class="btn-icon">üóëÔ∏è</span>
                                <span class="btn-text">Eliminar</span>
                            </button>
                        </div>
                        {% endif %}

                    </div>
                    {% empty %}
                        <p class="no-incidencias-message">No hay incidencias registradas todav√≠a.</p>
                    {% endfor %}

                </div>

                <!-- Paginaci√≥n -->
                {% if incidencias.has_other_pages %}
                <nav class="pagination-container" style="margin-top: 20px; text-align: center;">
                    <ul style="list-style: none; padding: 0; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;">
                        {% if incidencias.has_previous %}
                            <li>
                                <a href="?page=1{% if filtros_aplicados.fecha %}&fecha={{ filtros_aplicados.fecha }}{% endif %}{% if filtros_aplicados.turno %}&turno={{ filtros_aplicados.turno }}{% endif %}{% if filtros_aplicados.centro %}&centro={{ filtros_aplicados.centro }}{% endif %}{% if filtros_aplicados.tipo %}&tipo={{ filtros_aplicados.tipo }}{% endif %}" 
                                   style="padding: 8px 12px; background: #1a8a8a; color: white; text-decoration: none; border-radius: 5px;">
                                    ¬´ Primera
                                </a>
                            </li>
                            <li>
                                <a href="?page={{ incidencias.previous_page_number }}{% if filtros_aplicados.fecha %}&fecha={{ filtros_aplicados.fecha }}{% endif %}{% if filtros_aplicados.turno %}&turno={{ filtros_aplicados.turno }}{% endif %}{% if filtros_aplicados.centro %}&centro={{ filtros_aplicados.centro }}{% endif %}{% if filtros_aplicados.tipo %}&tipo={{ filtros_aplicados.tipo }}{% endif %}" 
                                   style="padding: 8px 12px; background: #1a8a8a; color: white; text-decoration: none; border-radius: 5px;">
                                    ‚Äπ Anterior
                                </a>
                            </li>
                        {% endif %}

                        <li style="padding: 8px 15px; background: #e0e0e0; border-radius: 5px; font-weight: bold;">
                            P√°gina {{ incidencias.number }} de {{ incidencias.paginator.num_pages }}
                        </li>

                        {% if incidencias.has_next %}
                            <li>
                                <a href="?page={{ incidencias.next_page_number }}{% if filtros_aplicados.fecha %}&fecha={{ filtros_aplicados.fecha }}{% endif %}{% if filtros_aplicados.turno %}&turno={{ filtros_aplicados.turno }}{% endif %}{% if filtros_aplicados.centro %}&centro={{ filtros_aplicados.centro }}{% endif %}{% if filtros_aplicados.tipo %}&tipo={{ filtros_aplicados.tipo }}{% endif %}" 
                                   style="padding: 8px 12px; background: #1a8a8a; color: white; text-decoration: none; border-radius: 5px;">
                                    Siguiente ‚Ä∫
                                </a>
                            </li>
                            <li>
                                <a href="?page={{ incidencias.paginator.num_pages }}{% if filtros_aplicados.fecha %}&fecha={{ filtros_aplicados.fecha }}{% endif %}{% if filtros_aplicados.turno %}&turno={{ filtros_aplicados.turno }}{% endif %}{% if filtros_aplicados.centro %}&centro={{ filtros_aplicados.centro }}{% endif %}{% if filtros_aplicados.tipo %}&tipo={{ filtros_aplicados.tipo }}{% endif %}" 
                                   style="padding: 8px 12px; background: #1a8a8a; color: white; text-decoration: none; border-radius: 5px;">
                                    √öltima ¬ª
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            </section>
        </div>

        <div class="sidebar-actions">
            <h4>üõ†Ô∏è Acciones</h4>
            
            <div class="action-group">
                <span>Navegaci√≥n</span>
                {% if es_admin %}
                <button onclick="window.location.href='{% url 'home' %}'">‚ûï Nuevo Reporte</button>
                {% endif %}
            </div>

            <div class="action-group">
            <span>Reportes</span>
   
            <button class="action-primary action-primary-green" id="exportPdfBtn">üñ®Ô∏è Generar PDF</button>
        </div>
            
            <div class="action-group">
                <span>Control de Par√°metros</span>
                <button onclick="window.location.href='{% url 'control_diario_santa_juana' %}'">üìä Control Diario</button>
            </div>

            <div class="action-group">
                <span>Dashboards</span>
                <button onclick="window.location.href='{% url 'dashboard' %}'">üìà General</button>
                
            </div>

            <div class="action-group">
                <span>Sesi√≥n</span>
                <form method="post" action="{% url 'logout' %}" style="width: 100%;">
                    {% csrf_token %}
                    <button type="submit" style="background: #e74c3c;">üîí Cerrar Sesi√≥n</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="{% static 'js/reporte.js' %}"></script>
    
</body>
</html>