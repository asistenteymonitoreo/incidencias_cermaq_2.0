{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Incidencias - Santa Juana</title>
    
    <link rel="stylesheet" href="{% static 'css/formulario.css' %}">
    
    <link rel="icon" type="image/png" href="{% static 'imagenes/logo-pesta√±a.png' %}">

    <style>
        /* Oculta el contenedor de Zona/Estanque si no es necesario */
        .zona-container.hidden {
            display: none;
        }

        /* Estilos para las alertas de JS (usa las clases de tu CSS) */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px; /* Mismo radio que tus secciones */
            font-weight: bold;
            text-align: center;
            font-size: 1em;
            border: 1px solid transparent;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>

    <div class="page-layout">
        
        <div class="form-container">
            
            <img src="{% static 'imagenes/logo-reporte-cermaq.png' %}" alt="Logo Reporte de Incidencias CERMAQ" class="form-logo">
            
            <h1>{% if incidencia_a_editar %}Editar Incidencia{% else %}Formulario de Incidencia{% endif %} - Centro Santa Juana</h1>

            <div id="alerta-container" style="margin-bottom: 20px;"></div>

            <form id="incidenciaForm" 
                  data-centro-slug="{{ centro_actual_slug|safe }}" 
                  data-api-url="{% url 'api-registrar-incidencia' %}"
                  data-update-url="{% if incidencia_a_editar %}{% url 'api-update-incidencia' incidencia_a_editar.pk %}{% endif %}"
                  data-incidencia-id="{{ incidencia_a_editar.pk|default:'' }}"
                  data-home-url="{% url 'home' %}">
                
                {% csrf_token %}
                <input type="hidden" id="id_centro_hidden" name="centro" value="">

                <div class="form-section">
                    <h2>1. Informaci√≥n B√°sica del Reporte</h2>
                    <div class="form-group">
                        <label for="fecha_hora">Fecha y Hora:</label>
                        <input type="datetime-local" id="fecha_hora" name="fecha_hora" required>
                    </div>
                    <div class="form-group">
                        <label for="turno">Turno:</label>
                        <select id="turno" name="turno" required>
                            <option value="" disabled selected>Seleccione Turno</option>
                            <option value="Ma√±ana">Ma√±ana</option>
                            <option value="Tarde">Tarde</option>
                            <option value="Noche">Noche</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h2>2. Ubicaci√≥n y Falla</h2>
                    <div class="form-group">
                        <label for="lugar">Lugar:</label>
                        <select id="lugar" name="modulo" required>
                            <option value="" disabled selected>Seleccione Lugar</option>
                        </select>
                    </div>
                    <div class="form-group zona-container" id="zona-container">
                        <label for="zona">Zona (Estanque):</label>
                        <select id="zona" name="estanque" required>
                            <option value="" disabled selected>Seleccione Zona</option>
                        </select>
                        
                        <!-- Checkbox para Incidencia General -->
                        <div style="margin-top: 12px;">
                            <input type="checkbox" id="afecta_todo_modulo" name="afecta_todo_modulo">
                            <label for="afecta_todo_modulo" style="font-weight: bold; color: #d9534f;">
                                üö® Incidencia General (Afecta todo el M√≥dulo)
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="equipo">Equipo:</label>
                        <select id="equipo" name="equipo" required disabled>
                            <option value="" disabled selected>Seleccione Equipo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sistema">Sistema:</label>
                        <select id="sistema" name="tipo_incidencia" required disabled>
                            <option value="" disabled selected>Seleccione Sistema</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipo_falla">Tipo de Falla (Detalle):</label>
                        <select id="tipo_falla" name="tipo_incidencia_normalizada" required disabled>
                            <option value="" disabled selected>Seleccione Falla</option>
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h2>3. Impacto y Observaciones</h2>
                    <div class="form-group">
                        <label>Riesgo Peces:</label>
                        <select id="riesgo_peces" name="riesgo_peces" required>
                            <option value="" disabled selected>Seleccione</option>
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Riesgo Personas:</label>
                        <select id="riesgo_personas" name="riesgo_personas" required>
                            <option value="" disabled selected>Seleccione</option>
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>P√©rdida Econ√≥mica:</label>
                        <select id="perdida_economica" name="perdida_economica" required>
                            <option value="" disabled selected>Seleccione</option>
                            <option value="true">S√≠</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="operario_contacto">Operario Contacto:</label>
                        <select id="operario_contacto" name="operario_contacto">
                            <option value="">Seleccione operario</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tiempo_resolucion">Tiempo Resoluci√≥n (Minutos):</label>
                        <input type="number" id="tiempo_resolucion" name="tiempo_resolucion" placeholder="Opcional">
                    </div>
                    <div class="form-group full-width">
                        <label for="observacion">Observaciones:</label>
                        <textarea id="observacion" name="observacion" rows="3" placeholder="Detalle la causa, acciones tomadas..."></textarea>
                    </div>
                </div>
                
                <button type="submit" id="submitForm">
                    {% if incidencia_a_editar %}
                        Actualizar Incidencia
                    {% else %}
                        Registrar Incidencia
                    {% endif %}
                </button>
            </form>
        </div>

        <!-- Sidebar de Acciones -->
        <div class="sidebar-actions">
            <h4>üõ†Ô∏è Acciones</h4>
            
            <div class="action-group">
                <span>Reportes</span>
                <button type="button" class="action-primary" onclick="window.location.href='{% url 'reporte' %}'">üìã Ver Reportes</button>
            </div>
            
            <div class="action-group">
                <span>Dashboards</span>
                <button onclick="window.location.href='{% url 'dashboard' %}'">üìà General</button>
            </div>
            
            <div class="action-group">
                <span>Navegaci√≥n</span>
                <button onclick="window.location.href='{% url 'home' %}'">üè† Inicio</button>
            </div>
            
            <div class="action-group">
                <span>Sesi√≥n</span>
                <form method="post" action="{% url 'logout' %}" style="width: 100%;">
                    {% csrf_token %}
                    <button type="submit" style="background: #e74c3c;">üîí Cerrar Sesi√≥n</button>
                </form>
            </div>
        </div>
        
    </div>

    {{ datos_operarios_json|json_script:"operarios-data" }}
    
    <script id="centros-data" type="application/json">
        [
            {% for centro in centros %}
                { "id": "{{ centro.id }}", "nombre": "{{ centro.nombre }}", "slug": "{{ centro.nombre|lower|slugify }}" }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    </script>

    <script id="incidencia-data" type="application/json">
        {{ incidencia_a_editar_json|safe }}
    </script>

    <script src="{% static 'js/formulario_sj.js' %}" defer></script>
</body>
</html>